<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House VR</title>

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        a {
            color: var(--color-blue);
            cursor: pointer;
            text-decoration: none;
        }

        #newWindow {
            display: block;
            position: absolute;
            bottom: 0em;
            left: 0.4em;
            color: #fff;
            text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
        }
    </style>

    <!-- Library of Virtual Reality -->
    <script type="text/javascript" charset="UTF-8" src="../libs/aframe-master.js"></script>
    <script type="text/javascript" charset="UTF-8" src="../libs/aframe-extras.js"></script>
    <script src="../libs/aframe-teleport-controls.js"></script>
    <!-- Details about aframe-extras "controls" here:
        https://github.com/donmccurdy/aframe-extras/tree/master/src/controls
    -->

    <script>
        let stairs, floor = [], isFlying = false;

        AFRAME.registerComponent('modify-materials', {
            init: function () {
                // Wait for model to load.
                this.el.addEventListener('model-loaded', () => {
                    // Grab the mesh
                    const obj = this.el.getObject3D('mesh');

                    obj.scale.set(1.3, 1.3, 1.3);

                    obj.children.forEach(element => {
                        if (/window/i.test(element.name)) {
                            element.children[0].material.transparency = true;
                            element.children[0].material.opacity = 0.7;
                        }

                        if (/water/i.test(element.name)) {
                            element.material.transparency = true;
                            element.material.opacity = 0.7;
                        }

                        if (/stairs/i.test(element.name)) {
                            stairs = element;
                        }

                        if (/ground|stairs|floor/i.test(element.name)) {
                            floor.push(element);
                        }
                        else if (/balcony|patio/i.test(element.name)) {
                            floor.push(element.children[1]);
                        }
                    });
                });
            }
        });

        AFRAME.registerComponent('listen-gamepad', {
            init: function () {
                const self = this;
                // mobile buttons indexes
                self.goDown = 4;
                self.goUp = 5;

                window.addEventListener("gamepadconnected", function (e) {
                    console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
                        e.gamepad.index, e.gamepad.id,
                        e.gamepad.buttons.length, e.gamepad.axes.length);

                    if (e.gamepad.buttons.length === 12) {
                        // desktop buttons indexes
                        self.goDown = 6;
                        self.goUp = 7;
                    }
                });

                // this.el.components['movement-controls'].nextData['fly'] = true;
            },
            tick: function (time, delta) {
                let gamepad = navigator.getGamepads()[0];

                if (gamepad) {
                    let position = this.el.object3D.position

                    if (gamepad.buttons[this.goUp].pressed) {
                        position.y += 0.005 * delta;
                        isFlying = true;
                    }
                    else if (gamepad.buttons[this.goDown].pressed && position.y > 0) {
                        position.y -= 0.005 * delta;
                    }
                }
            }
        });

        AFRAME.registerComponent('collision', {
            init: function () {
                this.height = this.el.getAttribute('position').y
                let parentPos = this.el.parentEl.getAttribute('position')

                this.raycaster = new THREE.Raycaster(new THREE.Vector3(), new THREE.Vector3(0, -1, 0).normalize(), 0, this.height + 0.5);
                this.pos = new THREE.Vector3(parentPos.x, this.height, parentPos.z);
            },
            tick: function (time, delta) {
                if (stairs) {
                    let parentPos = this.el.parentEl.object3D.position
                    this.pos.x = parentPos.x;
                    this.pos.y = parentPos.y + this.height;
                    this.pos.z = parentPos.z;
                    this.raycaster.ray.origin.copy(this.pos);

                    let intersectStairs = this.raycaster.intersectObject(stairs)[0];
                    if (intersectStairs) {
                        if (intersectStairs.distance <= this.height) {
                            parentPos.y += (this.height - intersectStairs.distance - 0.1);
                        }
                        else {
                            parentPos.y -= (intersectStairs.distance - this.height + 0.1);
                        }
                    }
                    else {
                        let intersectFloor = this.raycaster.intersectObjects(floor)[0]
                        if (intersectFloor) {
                            if (intersectFloor.distance <= this.height) {
                                parentPos.y += (this.height - intersectFloor.distance);
                                isFlying = false;
                            }
                            else if (!isFlying) {
                                parentPos.y -= 0.005 * delta
                            }
                        }
                        else if (!isFlying) {
                            if (parentPos.y >= -0.6) {
                                console.log(delta)
                                parentPos.y -= 0.005 * delta
                            }
                        }
                    }
                }
            }
        })
    </script>
</head>

<body>
    <a-scene main_scene id="scene" time light="defaultLightsEnabled: false" renderer="antialias: true; alpha: true">
        <a-entity id="rig" movement-controls position="-3 0 18" listen-gamepad>
            <a-entity id="camera" camera position="0 1.5 0" look-controls="pointerLockEnabled: true" collision>
            </a-entity>
        </a-entity>

        <a-assets timeout="60000">
            <a-asset-item id="house" src="../assets/models/modern-house.glb"></a-asset-item>
            <img id="skyBoxMap" src="../assets/textures/cloud.jpg">
        </a-assets>

        <a-entity light="type: ambient; color: #fff; intensity: 0.3"></a-entity>
        <a-entity light="color: #fff" position="65 110 52"></a-entity>

        <a-sky id="skyBox" material="src: #skyBoxMap"></a-sky>

        <a-entity id="house" gltf-model="#house" modify-materials></a-entity>

    </a-scene>>

</body>

</html>