<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
        }

        #stats {
            position: relative;
            width: 100%;
            height: 80px;
        }

        #main {
            position: relative;
            margin: 0;
        }

        #canvas-wrapper,
        #scatter-gl-container {
            position: relative;
        }
    </style>
</head>

<body>
    <div id="stats"></div>
    <div id="main">
        <div class="container">
            <div class="canvas-wrapper">
                <canvas id="output"></canvas>
                <video id="video" playsinline
                    style="-webkit-transform: scaleX(-1); transform: scaleX(-1); visibility: hidden; width: auto; height: auto;">
                </video>
            </div>
        </div>
    </div>
</body>

<!-- Load TensorFlow.js -->
<script src="https://unpkg.com/@tensorflow/tfjs"></script>
<!-- Load Posenet -->
<script src="https://unpkg.com/@tensorflow-models/posenet">
</script>
<script type="text/javascript">
    posenet.load().then(async function (net) {
        const imageScaleFactor = 0.50;
        const flipHorizontal = false;
        const outputStride = 16;

        const FPS = 30;
        const video = document.getElementById('video');

        await startVideo(video);

        video.width = video.videoWidth;
        video.height = video.videoHeight;

        const canvas = document.getElementById("output");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#FF0000";


        let pose;

        let begin, delay; // fps helpers
        async function processVideo() {
            begin = Date.now();

            pose = await net.estimateSinglePose(video, imageScaleFactor, flipHorizontal, outputStride);

            ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);

            for (let keypoint of pose.keypoints) {
                if (keypoint.score > 0.5) {
                    const circle = new Path2D();
                    circle.arc(keypoint.position.x, keypoint.position.y, 3, 0, 2 * Math.PI);
                    ctx.fill(circle);
                    ctx.stroke(circle);
                }
            }

            delay = 1000 / FPS - (Date.now() - begin);
            setTimeout(processVideo, delay);
        }

        setTimeout(processVideo, 0);
    });


    async function startVideo(video) {
        let stream; // video stream

        const constraints = {
            video: {
                facingMode: "environment",
                width: 360,
                height: 360
            },
            audio: false
        }

        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            video.play();

            return new Promise(function (resolve, reject) {
                video.addEventListener('loadeddata', function () {
                    resolve();
                });
            });
        }
        catch (err) {
            console.error('Error accesing camera:', err);
            alert('Error accessing camera')
        }
    }
</script>

</html>