<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuits VR</title>

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style>

    <!-- Library of Virtual Reality -->
    <script type="text/javascript" charset="UTF-8" src="../../libs/aframe-master.js"></script>
    <script type="text/javascript" charset="UTF-8" src="../../libs/vr-interface.js"></script>

    <script>
        AFRAME.registerComponent('panel', {
            init: function () {
                const self = this;
                const vrInterface = this.el.components['vr-interface'];
                const models = this.el.querySelectorAll('.panelModel');
                const clipboard = document.querySelector('#clipboard').object3D;

                clipboard.data = { type: '', rotation: 0 };

                vrInterface.addButton('wire', '#wire', () => {
                    addToClipboard('wire');
                    vrInterface.showMessage('Wire block added to clipboard');
                });
                vrInterface.addButton('l-block', '#lwire', () => {
                    addToClipboard('lblock');
                    vrInterface.showMessage('Curved wire block added to clipboard');
                });
                vrInterface.addButton('divisor-block', '#split', () => {
                    addToClipboard('divisor');
                    vrInterface.showMessage('Split wire block added to clipboard');
                });
                vrInterface.addButton('receptor-block', '#union', () => {
                    addToClipboard('receptor');
                    vrInterface.showMessage('Union wire block added to clipboard');
                });

                vrInterface.addButton('rotate', '#rotateImage', rotate);

                vrInterface.addButton('lamp', '#lamp', () => {
                    addToClipboard('lamp');
                    vrInterface.showMessage('Lamp block added to clipboard');
                });
                vrInterface.addButton('fan', '#fan', () => {
                    addToClipboard('fan');
                    vrInterface.showMessage('Fan block added to clipboard');
                });

                vrInterface.addButton('battery', '#battery', () => {
                    addToClipboard('battery');
                    vrInterface.showMessage('Battery block added to clipboard');
                });

                vrInterface.addButton('testing', '#testing', () => {
                    if (clipboard.debugCircuit) {
                        clipboard.debugCircuit();
                    }
                    else {
                        vrInterface.showMessage('Debug circuit can be executed only once');
                    }
                });

                function rotate() {
                    clipboard.rotation.x += Math.PI * 0.5;

                    if (clipboard.data.rotation === (-1.5 * Math.PI)) clipboard.data.rotation = 0;
                    else clipboard.data.rotation -= Math.PI * 0.5;

                    for (let i = 0; i < models.length; i++) {
                        models[i].object3D.rotation.x += Math.PI * 0.5;
                    }
                }

                function addToClipboard(type) {
                    clipboard.el.removeAttribute('gltf-model');

                    clipboard.data.type = type;
                    clipboard.el.setAttribute('gltf-model', `#${type}Model`);
                }
            }
        });

        AFRAME.registerComponent('grid', {
            init: function () {
                const vrGrid = this.el.components['vr-interface'];
                const clipboard = document.querySelector('#clipboard').object3D;
                const container = document.querySelector('#container').object3D;
                const batteries = [];
                this.actionBlocks = [];
                const matrix = new Array(45);


                for (let i = 0; i < 45; i++) {
                    vrGrid.addButton(i, null, placeBlock);
                }

                // ---- Testing: manually placing blocks
                clipboard.debugCircuit = function () {
                    let save = clipboard.data.rotation || 0;
                    clipboard.data.rotation = 0;

                    function addToClipboard(type) {
                        clipboard.el.removeAttribute('gltf-model');

                        clipboard.data.type = type;
                        clipboard.el.setAttribute('gltf-model', `#${type}Model`);
                    }

                    addToClipboard('battery');
                    setTimeout(() => {
                        clipboard.data.type = 'battery';
                        placeBlock(vrGrid.buttons[21])

                        addToClipboard('lblock');
                        setTimeout(() => {
                            placeBlock(vrGrid.buttons[31])

                            addToClipboard('lblock');
                            setTimeout(() => {
                                clipboard.data.rotation -= Math.PI * 0.5;
                                placeBlock(vrGrid.buttons[30])

                                addToClipboard('lblock');
                                setTimeout(() => {
                                    clipboard.data.rotation -= Math.PI * 0.5;
                                    placeBlock(vrGrid.buttons[12])

                                    addToClipboard('lblock');
                                    setTimeout(() => {
                                        clipboard.data.rotation -= Math.PI * 0.5;
                                        placeBlock(vrGrid.buttons[13])

                                        addToClipboard('lamp');
                                        setTimeout(() => {
                                            placeBlock(vrGrid.buttons[22])
                                            clipboard.data.rotation = save;
                                        }, 50);
                                    }, 50);
                                }, 50);
                            }, 50);
                        }, 50);
                    }, 50);

                    // ---- End of Testing: manually placing blocks

                    clipboard.debugCircuit = null;
                }

                function placeBlock(button) {
                    if (clipboard.children[0]) {
                        button.getWorldPosition(clipboard.children[0].position);

                        clipboard.children[0].name = button.name;
                        clipboard.children[0].type = clipboard.data.type;
                        clipboard.children[0].rotation.y = clipboard.data.rotation;

                        matrix[button.name] = clipboard.children[0];

                        if (clipboard.data.type === 'battery') {
                            batteries.push(clipboard.children[0]);
                        }
                        else if (clipboard.data.type === 'lamp') {
                            clipboard.children[0].action = lampAction;
                        }
                        else if (clipboard.data.type === 'fan') {
                            clipboard.children[0].action = fanAction;
                        }

                        container.add(clipboard.children[0]);
                        clipboard.el.removeAttribute('gltf-model');
                        updateCircuit();
                    }
                    else {
                        let block = container.getObjectByName(button.name);
                        if (block) {
                            container.remove(block);
                            matrix[block.name] = null;

                            if (block.type == 'battery') {
                                batteries.splice(batteries.indexOf(button), 1)
                            }
                            updateCircuit();
                        }
                    }

                }

                const self = this;
                function updateCircuit() {
                    for (let i = 0; i < self.actionBlocks.length; i++) {
                        self.actionBlocks[i].action(false);
                    }

                    if (batteries.length > 0) {
                        let pos;

                        for (let i = 0; i < batteries.length; i++) {
                            pos = batteries[i].name;

                            switch (batteries[i].rotation.y) {
                                case 0:
                                    pos += 9;
                                    break;
                                case -Math.PI:
                                    pos -= 9;
                                    break;
                                case -Math.PI * 0.5:
                                    pos -= 1;
                                    break;
                                default:
                                    pos += 1;
                            }

                            self.actionBlocks = [];
                            checkIsConnected(batteries[i].name, pos);
                        }
                    }
                }

                function checkIsConnected(batteryPos, pos, prev) {
                    let prevPos = prev || batteryPos;
                    let specialBlocks = [];

                    while (matrix[pos] && blocksConnect(matrix[pos], prevPos)) {
                        if (matrix[pos].action) {
                            specialBlocks.push(matrix[pos]);
                            self.actionBlocks.push(matrix[pos])
                        }

                        prevPos = pos;
                        pos = nextPosition(matrix[pos]);

                        if (pos.length) {
                            checkIsConnected(batteryPos, pos[1], prevPos);
                            pos = pos[0];
                        }

                        if (pos == batteryPos) {
                            for (let i = 0; i < specialBlocks.length; i++) {
                                specialBlocks[i].action(true);
                            }
                            return true;
                        }
                    }


                    return false;
                }

                function blocksConnect(obj, prevPos) {
                    if (obj.type === 'lblock') {
                        switch (obj.rotation.y) {
                            case 0:
                                return (obj.name - 1) === prevPos;
                            case -Math.PI:
                                return (obj.name + 1) === prevPos;
                            case -Math.PI * 0.5:
                                return (obj.name - 9) === prevPos;
                            default:
                                return (obj.name + 9) === prevPos;
                        }
                    }
                    else if (obj.type === 'receptor') {
                        switch (obj.rotation.y) {
                            case 0:
                                return (obj.name + 9) === prevPos || (obj.name + 1) === prevPos;
                            case -Math.PI:
                                return (obj.name - 9) === prevPos || (obj.name - 1) === prevPos;
                            case -Math.PI * 0.5:
                                return (obj.name - 1) === prevPos || (obj.name + 9) === prevPos;
                            default:
                                return (obj.name + 1) === prevPos || (obj.name - 9) === prevPos;
                        }
                    }
                    else {
                        switch (obj.rotation.y) {
                            case 0:
                                return (obj.name - 1) === prevPos;
                            case -Math.PI:
                                return (obj.name + 1) === prevPos;
                            case -Math.PI * 0.5:
                                return (obj.name - 9) === prevPos;
                            default:
                                return (obj.name + 9) === prevPos;
                        }
                    }
                }

                function nextPosition(obj) {
                    if (obj.type === 'lblock') {
                        switch (obj.rotation.y) {
                            case 0:
                                return obj.name - 9;
                            case -Math.PI:
                                return obj.name + 9;
                                break;
                            case -Math.PI * 0.5:
                                return obj.name + 1;
                            default:
                                return obj.name - 1;
                        }
                    }
                    if (obj.type === 'divisor') {
                        switch (obj.rotation.y) {
                            case 0:
                                return [obj.name - 9, obj.name + 1];
                            case -Math.PI:
                                return [obj.name + 9, obj.name - 1];
                                break;
                            case -Math.PI * 0.5:
                                return [obj.name + 1, obj.name + 9];
                            default:
                                return [obj.name - 1, obje.name - 9];
                        }
                    }
                    else if (obj.type === 'receptor') {
                        switch (obj.rotation.y) {
                            case 0:
                                return obj.name - 1;
                            case -Math.PI:
                                return obj.name + 1;
                            case -Math.PI * 0.5:
                                return obj.name - 9;
                            default:
                                return obj.name + 9;
                        }
                    }
                    else {
                        switch (obj.rotation.y) {
                            case 0:
                                return obj.name + 1;
                            case -Math.PI:
                                return obj.name - 1;
                            case -Math.PI * 0.5:
                                return obj.name + 9;
                            default:
                                return obj.name - 9;
                        }
                    }
                }

                function lampAction(isOn) {
                    if (isOn) {
                        this.children[2].material.emissive.set('#883333');
                    }
                    else {
                        this.children[2].material.emissive.set('#000000');
                    }
                }

                this.fans = [];
                function fanAction(isOn) {
                    if (isOn) {
                        self.fans.push(this);
                    }
                    else {
                        self.fans.splice(self.fans.indexOf(this), 1);
                    }
                }
            },
            tick: function (time, delta) {
                if (this.fans.length > 0) {
                    this.fans[0].children[2].rotation.y -= delta * 0.005;
                }
            },
        });
    </script>
</head>

<body>
    <a-scene main_scene id="scene" renderer="colorManagement: true;" background="color: #343434">
        <a-assets timeout="3000">
            <a-asset-item id="tableModel" src="../../assets/models/table.glb"></a-asset-item>
            <a-asset-item id="wireModel" src="../../assets/models/circuits/wire-block.glb"></a-asset-item>
            <a-asset-item id="lblockModel" src="../../assets/models/circuits/l-block.glb"></a-asset-item>
            <a-asset-item id="divisorModel" src="../../assets/models/circuits/divisor-block.glb"></a-asset-item>
            <a-asset-item id="receptorModel" src="../../assets/models/circuits/receptor-block.glb"></a-asset-item>
            <a-asset-item id="batteryModel" src="../../assets/models/circuits/battery-block.glb"></a-asset-item>
            <a-asset-item id="lampModel" src="../../assets/models/circuits/lamp-block.glb"></a-asset-item>
            <a-asset-item id="fanModel" src="../../assets/models/circuits/fan-block.glb"></a-asset-item>

            <img id="rotateImage" src="img/rotate.png">
            <img id="wire" src="img/wire.png">
            <img id="lwire" src="img/l-wire.png">
            <img id="split" src="img/split-wire.png">
            <img id="union" src="img/union-wire.png">
            <img id="lamp" src="img/lamp.png">
            <img id="fan" src="img/fan.png">
            <img id="battery" src="img/battery.png">
            <img id="testing" src="img/testing.png">
        </a-assets>

        <a-entity light="type: ambient; color: #fff; intensity: 0.3"></a-entity>
        <a-entity light="color: #fff" position="-15 110 30"></a-entity>

        <a-entity id="table" gltf-model="#tableModel" position="0 -0.03 -0.75" scale="1 1 1.05"></a-entity>

        <a-plane position="0 0 0" rotation="-90 0 0" width="10" height="10" color="#A1ACB3"></a-plane>

        <a-plane position="0 1.5 -1.51" width="2.1" height="1" color="#4D3100"></a-plane>
        <a-entity
            vr-interface="dimension: 1 5; orbits: 1.5; theta: 0; rho: 0; buttonSize: 0.4 0.4; gap: 0 0; border: 1 #6d7584; movementBar: false; transparency: true;"
            panel>
            <a-entity class="panelModel" gltf-model="#wireModel" position="-0.8 0 -1.5" rotation="90 90 90">
            </a-entity>
            <a-entity class="panelModel" gltf-model="#lblockModel" position="-0.4 0 -1.5" rotation="90 90 90">
            </a-entity>
            <a-entity class="panelModel" gltf-model="#divisorModel" position="0 0 -1.5" rotation="90 90 90">
            </a-entity>
            <a-entity class="panelModel" gltf-model="#receptorModel" position="0.4 0 -1.5" rotation="90 90 90">
            </a-entity>
            <a-entity class="panelModel" gltf-model="#lampModel" position="-0.8 -0.4 -1.5" rotation="90 90 90">
            </a-entity>
            <a-entity class="panelModel" gltf-model="#fanModel" position="-0.4 -0.4 -1.5" rotation="90 90 90">
            </a-entity>
            <a-entity class="panelModel" gltf-model="#batteryModel" position="0 -0.4 -1.5" rotation="90 90 90">
            </a-entity>
        </a-entity>

        <a-entity
            vr-interface="dimension: 5 9; worldPosition: 0 0.975 -0.75; rotation: -90 0 0; transparency: true; buttonSize: 0.2 0.2; border: 5 #6d7584; cursorPosition: 0 0 -0.65"
            grid>
        </a-entity>

        <a-entity id="container"></a-entity>

        <a-entity id="rig" position="0 0.1 0">
            <a-entity id="camera" camera position="0 1.6 0" look-controls="pointerLockEnabled: true"
                wasd-controls="acceleration:150; fly: true; enabled: true">
                <a-entity id="clipboard" position="0 0 -0.68" rotation="90 90 90" scale="0.3 0.3 0.3">
                </a-entity>
            </a-entity>
        </a-entity>
    </a-scene>

</body>

</html>