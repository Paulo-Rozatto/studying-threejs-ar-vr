<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diseases VR</title>

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style>

    <!-- Library of Virtual Reality -->
    <script type="text/javascript" charset="UTF-8" src="../../libs/aframe-master.js"></script>
    <script type="text/javascript" charset="UTF-8" src="../../libs/aframe-button-controls.js"></script>

    <script>
        AFRAME.registerComponent('menu', {
            dependencies: ['button-controls'],
            init: function () {
                const self = this;
                this.models = document.querySelectorAll('.menu-model');
                this.modelIndex = 0;
                this.camera = document.querySelector('#camera').object3D;

                this.cursor = document.querySelector('#cursor');
                this.raycaster = document.querySelector('[raycaster]');

                this.distance = this.camera.position.z - 0.25;
                let panelGeometry = new THREE.PlaneGeometry(0.03, 0.04)
                let width = 0.03;
                let panelHeight = 1.57;

                buttons = {
                    rotLeft: new THREE.Mesh(
                        panelGeometry,
                        new THREE.MeshBasicMaterial({
                            color: new THREE.Color(0xff0000),
                        })
                    ),
                    rotRight: new THREE.Mesh(
                        panelGeometry,
                        new THREE.MeshBasicMaterial({
                            color: new THREE.Color(0x0000FF),
                        })
                    ),
                    zoomIn: new THREE.Mesh(
                        panelGeometry,
                        new THREE.MeshBasicMaterial({
                            color: new THREE.Color(0x00FF00),
                        })
                    ),
                    zoomOut: new THREE.Mesh(
                        panelGeometry,
                        new THREE.MeshBasicMaterial({
                            color: new THREE.Color(0xF0AAF0),
                        })
                    ),
                    next: new THREE.Mesh(
                        panelGeometry,
                        new THREE.MeshBasicMaterial({
                            color: new THREE.Color(0x0f0f0f),
                        })
                    )
                }

                let i = -2;
                for (const key in buttons) {
                    buttons[key].position.set(i * width, panelHeight, this.distance);
                    buttons[key].name = key;

                    const entity = document.createElement('a-entity');
                    entity.setObject3D(key, buttons[key])

                    this.el.appendChild(entity);
                    i++;
                }

                this.el.object3D.visible = false;

                let buttonControls = document.querySelector('[button-controls]');
                buttonControls.addEventListener('buttondown', () => { // Listen click, touch, and joystick button pressed events
                    self.el.object3D.visible = true;

                    for (const child of this.el.children) {
                        child.classList.add('clickable');
                    }
                });
                buttonControls.addEventListener('buttonup', () => {
                    self.el.object3D.visible = false;

                    for (const child of this.el.children) {
                        child.classList.remove('clickable');
                    }
                });

                this.el.addEventListener('click', (evt) => self.clickHandle(evt)); // click == fuse click
                // this.el.addEventListener('mouseenter', () => console.log('enter'))
            },
            clickHandle: function (evt) {
                // console.log('I was clicked at: ', evt.detail.intersection.object);
                let obj = evt.detail.intersection.object;
                let model = this.models[this.modelIndex].object3D;

                switch (obj.name) {
                    case 'rotLeft':
                        model.rotation.y -= 1.2;
                        break;
                    case 'rotRight':
                        model.rotation.y += 1.2;
                        break;
                    case 'zoomIn':
                        if (model.position.z < -1)
                            model.position.z += 1;
                        break;
                    case 'zoomOut':
                        model.position.z -= 1;
                        break;
                    case 'next':
                        this.nextModel();
                        break;
                }

            },
            nextModel() {
                this.models[this.modelIndex].object3D.visible = false;

                if (this.modelIndex == this.models.length - 1) {
                    this.modelIndex = 0;
                }
                else {
                    this.modelIndex++;
                }

                this.models[this.modelIndex].object3D.visible = true;
            }
        });
    </script>
</head>

<body>
    <a-scene main_scene id="scene" gltf-model="dracoDecoderPath: ../../libs/draco/gltf/;">
        <a-assets timeout="3000">
            <a-asset-item id="aneurismModel" src="../../assets/models/diseases/an.glb"></a-asset-item>
            <a-asset-item id="strokeModel" src="../../assets/models/diseases/stroke.glb"></a-asset-item>
            <!-- <img id="text" src="assets/textures/text.png"> -->
        </a-assets>

        <a-entity light="type: ambient; color: #fff; intensity: 0.3"></a-entity>
        <a-entity light="color: #fff" position="-65 110 0"></a-entity>

        <a-sky color="#343434"></a-sky>

        <a-entity id="aneurism" class="menu-model" position="-1 0 -2" gltf-model="#aneurismModel"></a-entity>
        <a-entity id="stroke" class="menu-model" position="0 0 0" gltf-model="#strokeModel" visible="false"></a-entity>

        <a-plane position="0 0 0" rotation="-90 0 0" width="10" height="10" color="#A1ACB3"
            material="transparent: true; opacity: 0.5"></a-plane>

        <a-entity button-controls menu></a-entity>
        <a-entity id="rig" position="0 0 0">
            <a-entity id="camera" camera position="0 1.6 0" look-controls="pointerLockEnabled: true">
                <a-entity id="cursor" cursor="fuse: true; fuseTimeout: 1000" raycaster="far: 0.5; objects: .clickable"
                    position="0 0 -0.1" geometry="primitive: ring; radiusInner: 0.0005; radiusOuter: 0.0015"
                    material="color: white; shader: flat"
                    animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.1 0.1 0.1; to: 1 1 1"
                    animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1000; from: 1 1 1; to: 0.1 0.1 0.1">
                </a-entity>
            </a-entity>
        </a-entity>

    </a-scene>

</body>

</html>