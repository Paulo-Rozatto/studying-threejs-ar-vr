<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airplane VR</title>

    <style>
        #info {
            display: none;
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            width: 80%;
            transform: translateY(-50%);
            margin: auto;
            padding-left: 5px;
            background-color: rgba(255, 255, 255, 0.7);
            font-size: 1.2em;
            color: #444;
            z-index: 1;
        }

        @media only screen and (min-width: 768px) {
            #info {
                text-align: center;
            }
        }
    </style>

    <script type="text/javascript" charset="UTF-8" src="../../libs/aframe-master.js"></script>
    <script type="text/javascript" charset="UTF-8" src="../../libs/aframe-physics-system.js"></script>
    <script type="text/javascript" charset="UTF-8" src="../../libs/aframe-button-controls.js"></script>

    <script>
        AFRAME.registerComponent('move', {
            init: function () {
                this.obj = this.el.object3D;
                this.velocity = 50;
                this.vx = this.velocity;
                this.vz = 0;
                this.radiusSquared = 160000; // sqrt(90,000) = 300
                this.distanceSquared;

                this.el.setAttribute('velocity', { x: this.vx, y: 0, z: this.vz });

                this.crate = this.el.sceneEl.querySelector('#crate');

                this.TrajectoryPath = this.ProjectileCurve();
                this.path;
                this.trajectory;
                this.material = new THREE.LineBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.5 })


                this.path = new this.TrajectoryPath(new THREE.Vector3(0, -1, 0), 0, 0, 0, 0);
                this.trajectory = new THREE.Line(
                    new THREE.BufferGeometry().setFromPoints(this.path.getPoints(1)),
                    this.material
                );
                this.el.sceneEl.setObject3D('trajectory', this.trajectory);

                const self = this;
                let controlsEl = document.querySelector('[button-controls]');
                controlsEl.addEventListener('buttondown', function (evt) {
                    self.dropBox();
                });

                this.crate.addEventListener('collide', () => {
                    self.crate.setAttribute('velocity', { x: 0, y: 0, z: 0 });
                    if (self.crate.object3D.visible) self.crate.components.sound.playSound();
                });
            },
            tick: function (time, delta) {
                this.distanceSquared = (this.obj.position.x * this.obj.position.x) + (this.obj.position.z * this.obj.position.z);

                if (this.distanceSquared > this.radiusSquared) {
                    let x, z, theta;

                    // x^2 + z^2 = r^2
                    x = Math.floor(Math.random() * this.radiusSquared);
                    z = this.radiusSquared - x;

                    this.obj.position.x = Math.sqrt(x) * (Math.random() > 0.5 ? 1 : -1);
                    this.obj.position.z = Math.sqrt(z) * (Math.random() > 0.5 ? 1 : -1);

                    theta = Math.atan(this.obj.position.z / this.obj.position.x);
                    this.obj.rotation.y = (Math.PI / 2) - theta;

                    this.vx = this.velocity * Math.cos(theta);
                    this.vz = this.velocity * Math.sin(theta);

                    this.el.setAttribute('velocity', { x: this.vx, y: 0, z: this.vz });
                }

            },
            dropBox: function () {
                this.crate.object3D.visible = true;
                this.crate.body.position.set(this.obj.position.x, this.obj.position.y, this.obj.position.z)
                this.crate.body.angularVelocity.set(0, 0, 0);
                this.crate.body.velocity.set(this.vx, 0, this.vz);

                this.path = new this.TrajectoryPath(
                    this.obj.position,
                    this.velocity,
                    0,
                    this.obj.rotation.y - (Math.PI / 2),
                    9.8,
                    10
                );
                this.path = this.path.getPoints(30)
                this.trajectory.geometry = new THREE.BufferGeometry().setFromPoints(this.path);
                this.trajectory.geometry.needsupdate = true;
            },
            ProjectileCurve: function () {
                function ProjectileCurve(p0, velocity, verticalAngle, horizontalAngle, gravity, scale) {
                    THREE.Curve.call(this);

                    if (p0 === undefined || velocity === undefined || verticalAngle === undefined || horizontalAngle === undefined) {
                        return null;
                    }

                    let vhorizontal = velocity * Math.cos(verticalAngle);

                    this.p0 = p0;
                    this.vy = velocity * Math.sin(verticalAngle);
                    this.vx = velocity * Math.cos(horizontalAngle);
                    this.vz = velocity * Math.sin(horizontalAngle);
                    this.g = (gravity === undefined) ? -9.8 : gravity;
                    this.scale = (scale === undefined) ? 1 : scale;

                    if (this.g > 0) this.g *= -1;
                }
                ProjectileCurve.prototype = Object.create(THREE.Curve.prototype);
                ProjectileCurve.prototype.constructor = ProjectileCurve;

                ProjectileCurve.prototype.getPoint = function (t) {
                    t *= this.scale;
                    let x = this.p0.x + this.vx * t;
                    let y = this.p0.y + ((this.vy * t) + (this.g * 0.5 * (t * t)));
                    let z = this.p0.z - this.vz * t;
                    return new THREE.Vector3(x, y, z);

                };

                return ProjectileCurve
            }
        });

        AFRAME.registerComponent('showinfo', {
            init: function () {
                document.getElementById('info').style.display = 'block';
            }
        })
    </script>
</head>

<body>
    <div id="info">
        <h2>Instructions: </h2>
        <p><b>Google Cardboard:</b> press the button to release the crate</p>
        <p><b>Joystick:</b> Press any button to release the crate</p>
        <p><b>Mouse:</b> Click in the screen to release the crate</p>
        <p><b>VR Mode:</b> Press the VR button in the bottom right corner;</p>
    </div>

    <a-scene id="scene" physics="friction: 0.8; restitution: 0.1" stats>
        <a-assets timeout="3000">
            <a-asset-item id="airplaneModel" src="../../assets/models/airplane.glb"></a-asset-item>
            <img id="skyBoxMap" src="../../assets/textures/cloud.jpg">
            <img id="grass" src="../../assets/textures/grass.png">
            <img id="crateTexture" src="../../assets/textures/crate.png">

            <!-- Huggy13ear https://freesound.org/s/138957/-->
            <audio id="airplaneSound" src="../../assets/sounds/airplane.wav"></audio>
            <audio id="crateSound" src="../../assets/sounds/dropped-wood.wav"></audio>
        </a-assets>

        <a-entity showinfo button-controls></a-entity>

        <a-entity light=" type: ambient; color: #fff; intensity: 0.1">
        </a-entity>
        <a-entity light="color: #fff" position="65 110 52"></a-entity>

        <a-sky id="skyBox" material="src: #skyBoxMap" radius="700"></a-sky>

        <a-plane id="ground" material="src: #grass; repeat: 140, 60" position="0 0 0" rotation="-90 0 0" width="1400"
            height="500" static-body>
        </a-plane>

        <a-box id="crate" src="#crateTexture" height="4" width="4" depth="4" position="-3 3 190" visible="false"
            dynamic-body="linearDamping: 0; angularDamping: 0.01;"
            sound="src: #crateSound; poolSize: 2; refDistance: 50; volume: 6;">
        </a-box>

        <a-entity id="airplane" gltf-model="#airplaneModel" position="0 200 0" rotation="0 90 0" scale="0.25 0.25 0.25"
            body="type: dynamic; mass: 0; shape: none;"
            sound="src: #airplaneSound; on: click; autoplay: true; loop: true;volume: 5; refDistance: 50; rolloffFactor: 1; distanceModel: exponential"
            move>
        </a-entity>

        <a-entity id="rig" position="0 0 0">
            <a-entity id="camera" camera position="0 1.5 0" look-controls>
            </a-entity>
        </a-entity>

    </a-scene>
</body>

</html>