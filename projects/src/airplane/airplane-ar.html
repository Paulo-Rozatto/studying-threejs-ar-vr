<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>AR - Airplane</title>

    <style>
        html,
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>

    <script src="../../libs/aframe-master.js"></script>
    <script src="../../libs/aframe-ar.js"></script>
    <script src="../../libs/aframe-aabb-collider-component.min.js"></script>
    <script src="../../libs/dat.gui.min.js"></script>

    <script>
        AFRAME.registerComponent('simulator', {
            init: function () {
                this.airplane = document.querySelector('#airplane').object3D;
                this.target = document.querySelector('#target').object3D;
                this.crate = document.querySelector('#crate').object3D;

                this.marker1 = document.querySelector('#hiro').object3D;
                this.marker2 = document.querySelector('#kanji').object3D;

                this.velocity = 2;
                this.delta;
                this.distance;
                this.time = 0;
            },
            tick: function (tickTime, tickDelta) {
                if (this.marker1.visible && this.marker2.visible) {
                    this.distance = this.marker1.position.distanceTo(this.marker2.position);
                    controls.distance = this.distance * 10;
                }

                if (controls.simulate) {
                    this.airplane.visible = true;

                    this.delta = tickDelta * 0.001 // ms to s

                    this.airplane.position.z += this.velocity * this.delta * -1;
                    this.crate.position.z = this.airplane.position.z;

                    if (this.airplane.position.z <= 0) {
                        this.crate.position.y = 1.5 + (-0.49 * (this.time * this.time));
                        this.time += this.delta;

                        if (this.crate.position.y <= 0) {
                            controls.simulate = false;
                            console.log(this.time);
                            this.time = 0;
                        };
                    }

                }
            }
        });
    </script>
</head>

<body>
    <a-scene id="scene" vr-mode-ui="enabled: false" embedded arjs='sourceType: webcam;'
        renderer="logarithmicDepthBuffer: true">
        <a-assets timeout="60000">
            <a-asset-item id="airplaneModel" src="../../assets/models/airplane.glb"></a-asset-item>
            <img id="crateTexture" src="../../assets/textures/crate.png" />
            <img id="targetTexture" src="../../assets/textures/target.png" />
            <img id="arrowTexture" src="../../assets/textures/arrow.png" />
        </a-assets>

        <a-marker id="hiro" preset="hiro" name="">
            <a-entity id="airplane" gltf-model="#airplaneModel" position="0 1.5 0" rotation="0 180 0"
                scale="0.01 0.01 0.01" visible="false">
            </a-entity>
            <a-box id="crate" src="#crateTexture" height="0.1" width="0.1" depth="0.1" position="0 1.5 0"
                visible="false" aabb-collider="objects: #target">
            </a-box>
            <a-plane id="arrow" src="#arrowTexture" material="transparent: true" height="0.5" width="0.5"
                rotation="-90 0 0"></a-plane>
        </a-marker>

        <a-marker preset='kanji' id="kanji">
            <a-circle id="target" src="#targetTexture" material="transparent: true" radius="0.3" rotation="-90 0 0">
            </a-circle>
        </a-marker>

        <a-entity id="camera" camera></a-entity>
        <a-entity simulator></a-entity>
    </a-scene>

    <script>
        function quadraticTime(a, b, c) {
            // This uses the quadratic formula to solve for time in a linear motion with constant aceleration
            // It returns null when the result is negative once negative time doesn't make sense
            // ax^2 + bx + c = 0

            let delta = (b * b) - 4 * a * c;

            if (delta < 0) return null;

            let x;

            if (delta === 0) {
                x = -b / 2 * a;
                return x >= 0 ? x : null;
            }

            x = (-b - Math.sqrt(delta)) / (2 * a);
            if (x > 0) return x;

            x = (-b + Math.sqrt(delta)) / (2 * a);
            if (x > 0) return x;

            return null;
        }
        const controls = new function () {
            this.height = 15;
            this.velocity = 20;
            this.distance = 0;
            this.simulate = false;
            this.startSimulation = function () {
                let airplane = document.querySelector("#airplane").object3D;
                let crate = document.querySelector("#crate").object3D;

                crate.visible = true;
                crate.position.y = 1.5;
                airplane.visible = true;
                airplane.position.z = 1.5;
                this.simulate = true;

                console.log(quadraticTime(-0.49, 0, 1.5))
            }
        }

        const gui = new dat.GUI();
        gui.add(controls, 'height').name('height (m)').listen();
        gui.add(controls, 'velocity').name('velocity (m/s)').listen();
        gui.add(controls, 'distance').name('distance (m)').listen();
        gui.add(controls, 'startSimulation').name('Start simulation');
    </script>
</body>


</html>