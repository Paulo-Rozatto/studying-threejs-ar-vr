<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing Room VR</title>

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style>

    <!-- Library of Virtual Reality -->
    <script type="text/javascript" charset="UTF-8" src="../../libs/aframe-master.js"></script>
    <script type="text/javascript" charset="UTF-8" src="../../libs/vr-interface.js"></script>

    <script>
        AFRAME.registerComponent('config', {
            init: function () {
                const self = this;

                this.isMoving = false;
                this.timeSum = 0;
                this.horizontalTurns = 2;
                this.verticalTurns = 0;

                this.arrow = document.querySelector('#arrow').object3D;

                const messages = [
                    `OrBI é uma interface com usuário pensada para realidade virtual.
                    OrBI é posicionada em relação ao usuário e pode ser movida dentro de uma esfera imaginária,
                    como no exemplo à direita.`,
                    `Nesse teste, será pedido para posicionar interface em algumas posições difertentes para se avaliar a precisão da OrBI e sua facilade
                    de uso.
                    Clique em próximo para continuar começar.`
                ]
                let msgIndex = 0;

                const vrInterface = this.el.components['vr-interface'];
                this.testInterface = document.querySelector('#example').components['vr-interface'];

                vrInterface.addButton('next', '#next', () => {
                    msgIndex++;
                    if (msgIndex < 2) {
                        vrInterface.showSideText(messages[msgIndex]);
                    }
                    else if (msgIndex === 2) {
                        vrInterface.hide();
                        self.testInterface.showMessage('Mova a interface para direita')

                        self.isToAnimateMan = false;
                        self.isMoving = true;
                        self.verticalTurns = 0;
                        self.horizontalTurns = 0;
                        self.testInterface.el.object3D.rotation.y = 0;
                        self.testInterface.buttonGroup.object3D.rotation.x = 0;

                        self.rig.setAttribute('position', '0 0 0');
                        self.rig.setAttribute('rotation', '0 -40 0')

                        manEl.object3D.visible = false;
                        sphereWireframe.visible = false;
                        self.arrow.visible = true;
                    }
                });
                vrInterface.showSideText(messages[0]);

                this.testInterface.addButton('b1', '#b1', () => { vrInterface.showMessage('button 1') });
                this.testInterface.addButton('b2', '#b2');
                this.testInterface.addButton('b3', '#b3');
                this.testInterface.addButton('b4', '#b4');

                const sphereEdges = new THREE.EdgesGeometry(new THREE.SphereGeometry(1.1, 18, 18));
                const sphereWireframe = new THREE.LineSegments(sphereEdges, new THREE.LineBasicMaterial({ color: 0xffffff }));
                sphereWireframe.position.y = 1.6;
                this.el.sceneEl.setObject3D("sphere", sphereWireframe);

                const squareEdges = new THREE.EdgesGeometry(new THREE.PlaneGeometry(0.45, 0.45))
                const squareWireframe = new THREE.LineSegments(squareEdges, new THREE.LineBasicMaterial({ color: 0xff0000 }));
                this.squareLocations = [
                    { position: new THREE.Vector3(1, 1.6, 0), rotation: new THREE.Euler(0, Math.PI / 2, 0), theta: Math.PI / 2, rho: 0 },
                    { position: new THREE.Vector3(0.87, 2.1, 0), rotation: new THREE.Euler(0.52, -Math.PI / 2, 0, 'YXZ'), theta: Math.PI / 2, rho: Math.PI / 6 },
                    { position: new THREE.Vector3(0, 1.6, -1), rotation: new THREE.Euler(0, 0, 0), theta: 0, rho: 0 },
                ];
                squareWireframe.position.copy(this.squareLocations[0].position);
                squareWireframe.rotation.copy(this.squareLocations[0].rotation);
                this.el.sceneEl.setObject3D('square', squareWireframe);
                this.square = squareWireframe;
                this.squareIdx = 0;

                this.testInterface.stopButtonCallback = () => {
                    if (self.squareIdx < 2) {
                        self.arrow.rotation.y = -Math.PI * 0.5;
                        self.arrow.rotation.z = 1.5 * self.arrow.rotation.z + Math.PI * 0.5;
                        self.arrow.position.copy(squareWireframe.position);
                        self.arrow.position.z -= 0.5;

                        self.squareIdx++;
                        squareWireframe.position.copy(self.squareLocations[self.squareIdx].position);
                        squareWireframe.rotation.copy(self.squareLocations[self.squareIdx].rotation);

                        this.square.material.color.r = 1;
                        this.square.material.color.g = 0;
                    }
                }

                const manEl = document.querySelector('#man');
                this.isToAnimateMan = false;

                manEl.addEventListener('model-loaded', () => {
                    self.head = manEl.object3D.children[0].children[5];
                    self.isToAnimateMan = true;

                    self.rig = document.querySelector('#rig');
                    self.rig.setAttribute('position', '-2 0 2');
                    vrInterface.updatePosition();
                });
            },
            tick: function (time, delta) {
                if (this.isToAnimateMan) {
                    this.manAnimation(delta);
                }

                if (this.isMoving) {
                    if (this.testInterface.data.theta > -(this.squareLocations[this.squareIdx].theta + 0.02) && this.testInterface.data.theta < -(this.squareLocations[this.squareIdx].theta - 0.02)
                        && this.testInterface.data.rho < (this.squareLocations[this.squareIdx].rho + 0.02) && this.testInterface.data.rho > (this.squareLocations[this.squareIdx].rho - 0.02)) {
                        if (this.square.material.color.r = 1) {
                            this.square.material.color.r = 0;
                            this.square.material.color.g = 1;
                        }
                    }
                    else if (this.square.material.color.g = 1) {
                        this.square.material.color.r = 1;
                        this.square.material.color.g = 0;
                    }
                }
            },
            manAnimation: function (delta) {
                if (this.horizontalTurns > 0) {
                    this.timeSum += delta * 0.001
                    this.head.rotation.y = Math.sin(this.timeSum);
                    this.testInterface.el.object3D.rotation.y = this.head.rotation.y;

                    if (this.head.rotation.y < 0.01 && this.head.rotation.y > -0.01) {
                        this.horizontalTurns -= 1;

                        if (this.horizontalTurns == 0) {
                            this.verticalTurns = 2;
                        }
                    }
                }
                else if (this.verticalTurns > 0) {
                    this.timeSum += delta * 0.001
                    this.head.rotation.x = Math.sin(this.timeSum);
                    this.testInterface.buttonGroup.object3D.rotation.x = this.head.rotation.x;

                    if (this.head.rotation.x < 0.01 && this.head.rotation.x > -0.01) {
                        this.verticalTurns -= 1;

                        if (this.verticalTurns == 0) {
                            this.horizontalTurns = 2;
                        }
                    }
                }
            }
        });
    </script>
</head>

<body>
    <a-scene main_scene id="scene" renderer="colorManagement: true;" background="color: #343434">
        <a-assets>
            <a-asset-item id="manModel" src="man.glb"></a-asset-item>

            <img id="next" src="img/next-br.png">
            <img id="b1" src="img/action1.png">
            <img id="b2" src="img/action2.png">
            <img id="b3" src="img/action3.png">
            <img id="b4" src="img/action4.png">
            <img id="arrowTexture" src="img/arrow.png">
        </a-assets>

        <a-entity id="man" gltf-model="#manModel" test></a-entity>

        <a-entity light="type: ambient; color: #fff; intensity: 0.3"></a-entity>
        <a-entity light="color: #fff" position="-15 110 30"></a-entity>

        <a-plane id="floor" rotation="-90 0 0" color="#645434" height="10" width="10"></a-plane>

        <a-plane id="wall-1" rotation="0 0 0" position="0 1.5 -5" color="#777777" height="3" width="10"></a-plane>
        <a-plane id="wall-2" rotation="0 180 0" position="0 1.5 5" color="#777777" height="3" width="10"></a-plane>
        <a-plane id="wall-3" rotation="0 90 0" position="-5 1.5 0" color="#777777" height="3" width="10"></a-plane>
        <a-plane id="wall-3" rotation="0 -90 0" position="5 1.5 0" color="#777777" height="3" width="10"></a-plane>

        <a-plane id="arrow" height="0.15" width="0.15" material="src: #arrowTexture; transparent: true;"
            position="0.3 1.6 -1.1"
            animation="property: material.opacity; dir: alternate; from: 0.66; to: 0.2; dur: 500; loop: true;"
            visible="false">
        </a-plane>

        <a-entity id="rig" position="0 0 0">
            <a-entity id="camera" camera position="0 1.6 0" look-controls="pointerLockEnabled: true"
                wasd-controls="acceleration:150; fly: false; enabled: true">
            </a-entity>
        </a-entity>

        <a-entity id="example" vr-interface="dimension: 2 2; orbits: 1; theta: 0; gap: 0.01 0.01; buttonSize: 0.2 0.2; border: 1 #f2f2f2; transparency: true;
            font: roboto-msdf.json; negate: false;">
        </a-entity>

        <a-entity vr-interface="dimension: 1 1; orbits: 1.25; theta: 40; sideTextRotation: -40; gap: 0.01 0.01; buttonSize: 0.2 0.2; border: 1 #f2f2f2; transparency: true;
            font: roboto-msdf.json; negate: false; sideTextSize: 0.3 3" config>
        </a-entity>

    </a-scene>

</body>

</html>